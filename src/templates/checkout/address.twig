{% extends 'foster-checkout/_layouts/default' %}
{% set addresses = currentUser ? (currentUser.addresses.all() ?? null) : null %}
{% set primaryShippingAddressId = currentUser ? (currentUser.getPrimaryShippingAddressId() ?? -1) : -1 %}

{% block head %}
	<title>
		{{ craft.fostercheckout.settings.branding.title ? craft.fostercheckout.settings.branding.title : siteName }} |
		{{ 'misc.checkoutTitle'|t('foster-checkout') }} : {{ 'address.stepTitle'|t('foster-checkout') }}
	</title>
{% endblock %}

{% block body %}
	{# If a user address was chosen, Commerce sets cart.sourceShippingAddressId to that address-book id. #}
	{# If "new address" was chosen, sourceShippingAddressId is null but cart.shippingAddressId exists. #}
	{% set _sourceId = cart.sourceShippingAddressId ?? null %}
	{% set _hasCartShip = cart.shippingAddressId is not empty %}
	{% set _hasBookAddresses = currentUser and addresses|length %}
	{# New address when: using a cart address OR there are no saved addresses #}
	{% set _isNew = (_sourceId is null) and (_hasCartShip or not _hasBookAddresses) %}
	{% set _initialRadio = _isNew ? 0 : (_sourceId ?? 0) %}

	<div class="mt-10 pb-28 lg:pb-32">
		<div class="grid grid-cols-1 gap-16 lg:grid-cols-[1fr_380px] lg:gap-6 xl:grid-cols-[1fr_32.03125%] xl:gap-8">
			<main
				x-data="{
				  editExistingAddress: 0,
				  shippingAddressId: {{ _initialRadio }},
				  useNewAddress: {{ _isNew ? 1 : 0 }},
				}"
				x-init="useNewAddress = Number(shippingAddressId) === 0 ? 1 : useNewAddress"
				x-effect="
				  $refs.postShipId.value = shippingAddressId;
				  $refs.postUseNew.value = useNewAddress ? 1 : 0;
				"
				class="pb-8 border-b border-gray-300 lg:pb-0 lg:border-b-0"
			>
				<div class="grid grid-cols-1 gap-4 xl:gap-6 ">
					{% include 'foster-checkout/_components/app/steps-completed' with { step: 'address' } %}

					<form method="post">
						{{ csrfInput() }}

						{# Always post the current selection. When new is selected, this posts 0 which tells Commerce not to bind to an address-book id. #}
						<input type="hidden" x-ref="postShipId" name="shippingAddressId" value="{{ _initialRadio }}">
						<input type="hidden" x-ref="postUseNew" name="useNewAddress" value="{{ _isNew ? 1 : 0 }}">

						<template x-if="editExistingAddress === 0">
							<div>
								{{ actionInput('commerce/cart/update-cart') }}
								{{ redirectInput(siteUrl(craft.fostercheckout.settings.paths.checkout) ~ '/shipping') }}
								{{ hiddenInput('billingAddressSameAsShipping', 1) }}
							</div>
						</template>
						<template x-if="editExistingAddress !== 0">
							<div>
								{{ actionInput('users/save-address') }}
								{{ redirectInput(siteUrl(craft.fostercheckout.settings.paths.checkout) ~ '/address') }}
								<input type="hidden" name="addressId" :value="editExistingAddress"/>
							</div>
						</template>

						<div class="border border-gray-250 rounded-lg overflow-hidden {{ craft.fostercheckout.settings.branding.style|default('rounded') == 'flat' ? 'lg:border lg:border-gray-300' : 'lg:border lg:border-gray-250' }}">
							<h2 class="p-4 font-semibold bg-gray-200">
								{{ 'address.stepName'|t('foster-checkout') }}
							</h2>

							<div class="p-4">
								<div class="xl:border xl:border-gray-250 xl:rounded-lg xl:overflow-hidden">

									{% if currentUser and addresses|length %}
										{% for address in addresses %}
											<div class="p-4 border-b border-gray-250"
												 :class="{ 'bg-gray-100': (parseInt(shippingAddressId) === {{ address.id }} && useNewAddress === 0) }">
												<div class="flex justify-between items-center gap-4 radio">
													<input
														x-model.number="shippingAddressId"
														id="address_{{ address.id }}"
														name="shippingAddressId_radio"
														type="radio"
														class="sr-only"
														value="{{ address.id }}"
														@change="useNewAddress = 0; editExistingAddress = 0"
													/>
													<label
														for="address_{{ address.id }}"
														class="inline-flex justify-start items-center gap-4 cursor-pointer"
														:class="{ 'font-medium text-black': parseInt(shippingAddressId) === {{ address.id }} && useNewAddress === 0 }"
													>
														{% include 'foster-checkout/_components/app/formatted-address' with { address: address } %}
													</label>

													<template x-if="parseInt(shippingAddressId) === {{ address.id }} && useNewAddress === 0">
														<button
															type="button"
															class="text-[var(--brandColor)] underline"
															@click="editExistingAddress = parseInt(editExistingAddress) === {{ address.id }} ? 0 : {{ address.id }}"
														>
															<template x-if="parseInt(editExistingAddress) === {{ address.id }}"><span>{{ 'misc.cancel'|t('foster-checkout') }}</span></template>
															<template x-if="parseInt(editExistingAddress) !== {{ address.id }}"><span>{{ 'misc.edit'|t('foster-checkout') }}</span></template>
														</button>
													</template>
												</div>

												<template x-if="parseInt(editExistingAddress) === {{ address.id }}">
													<div class="pt-8">
														{% include 'foster-checkout/_components/app/address-fields' %}
														<div class="flex justify-start items-center gap-4 mt-4 pt-4">
															<button type="submit" class="block min-w-[100px] px-4 py-3 font-medium text-white text-center bg-[var(--brandColor)] border border-[var(--brandColor)] rounded-lg sm:min-w-[140px] md:min-w-[200px]">
																{{ 'misc.save'|t('foster-checkout') }}
															</button>
															<button type="button" class="block min-w-[100px] px-4 py-3 font-medium text-[var(--brandColor)] text-center bg-white border border-[var(--brandColor)] rounded-lg sm:min-w-[140px] md:min-w-[200px]" @click="editExistingAddress = 0">
																{{ 'misc.cancel'|t('foster-checkout') }}
															</button>
														</div>
													</div>
												</template>
											</div>
										{% endfor %}
									{% endif %}
									{# end address list #}

									<div :class="{ 'bg-gray-100': parseInt(shippingAddressId) === 0 || useNewAddress }">
										<div class="p-4 radio">
											<input
												id="address_0"
												name="shippingAddressId_radio"
												type="radio"
												class="sr-only"
												x-model.number="shippingAddressId"
												value="0"
												@change="useNewAddress = 1; editExistingAddress = 0"
											/>
											<label
												for="address_0"
												class="inline-flex justify-start items-center gap-4 cursor-pointer"
												:class="{ 'font-medium text-black': useNewAddress || parseInt(shippingAddressId) === 0 }"
											>
												{{ 'address.newAddress'|t('foster-checkout') }}
											</label>
										</div>

										{# Save-to-book checkbox block. You can keep this exactly as before. #}
										{%- set initialSaveParam = craft.app.request.getParam('saveShippingAddressOnOrderComplete') -%}
										{%- set initialSaveChecked = initialSaveParam is not empty and initialSaveParam|trim != '0' -%}

										<div
											x-data="{
												saveToBook: (sessionStorage.getItem('saveShip') !== null)
												  ? JSON.parse(sessionStorage.getItem('saveShip'))
												  : {{ initialSaveChecked ? 'true' : 'false' }},
											  }"
											x-init="$watch('saveToBook', v => sessionStorage.setItem('saveShip', JSON.stringify(v)))"
										>
											<div x-show="useNewAddress" x-cloak>
												<div class="p-4">
													{% set address = null %}
													{% if currentUser and cart.sourceShippingAddressId is not null %}
														{% set address = craft.addresses().owner(currentUser).id(cart.sourceShippingAddressId).one() %}
													{% elseif cart.shippingAddressId is not null %}
														{% set address = craft.addresses().id(cart.shippingAddressId).one() %}
													{% endif %}

													{% include 'foster-checkout/_components/app/address-fields' with {
														context: 'shippingAddress',
														address: null,
													} %}

													{% if currentUser %}
														<div class="mt-4 p4 checkbox">
															<input type="hidden" name="saveShippingAddressOnOrderComplete" :value="saveToBook ? 1 : 0">

															<input
																type="checkbox"
																id="saveShippingAddressOnOrderComplete"
																class="sr-only"
																x-model="saveToBook"
																:checked="saveToBook"
																aria-checked="saveToBook.toString()"
															/>
															<label
																class="inline-flex justify-start items-center gap-4 cursor-pointer font-medium text-gray-500"
																for="saveShippingAddressOnOrderComplete"
															>
																{{ 'address.saveToAddressBook'|t('foster-checkout') }}
															</label>
														</div>
													{% endif %}
												</div>
											</div>
										</div>
									</div>
								</div>

								{% set note = craft.fostercheckout.note('address') %}
								{% if note %}
									<div class="mt-4 text-sm text-gray-500 [&_a]:underline [&_a:hover]:decoration-current">
										{{ note|raw }}
									</div>
								{% endif %}

								<div class="mt-6 grid grid-cols-1 gap-4 md:flex md:justify-end md:items-center md:gap-6">
									<a href="{{ siteUrl(craft.fostercheckout.settings.paths.cart) }}" class="hidden md:block min-w-[200px] px-4 py-3 font-medium text-[var(--brandColor)] text-center bg-white">
										{{ 'misc.returnToCart'|t('foster-checkout') }}
									</a>
									<button type="submit" class="block min-w-[200px] px-4 py-3 font-medium text-white text-center bg-[var(--brandColor)] border border-[var(--brandColor)] rounded-lg">
										{{ 'address.nextStep'|t('foster-checkout') }}
									</button>
								</div>
							</div>
						</div>
					</form>

					{% include 'foster-checkout/_components/app/steps-uncompleted' with { step: 'address' } %}
				</div>

				{% include 'foster-checkout/_components/app/checkout-footer-links' %}

			</main>

			<aside>
				<div class="grid grid-cols-1 gap-10 lg:p-4 lg:bg-white lg:rounded-lg {{ craft.fostercheckout.settings.branding.style|default('rounded') == 'flat' ? 'lg:border lg:border-gray-300' : 'lg:border lg:border-gray-250' }}">
					<div class="grid grid-cols-1 gap-6">
						<div class="flex justify-between items-center gap-4">
							<h2 class="text-xl font-bold text-gray-800 leading-snug">
								{{ 'summary.itemsTitle'|t('foster-checkout') }}
							</h2>
							<a href="{{ siteUrl(craft.fostercheckout.settings.paths.cart) }}" class="inline-block text-[var(--brandColor)] underline">
								{{ 'misc.edit'|t('foster-checkout') }}
							</a>
						</div>

						<ul class="grid grid-cols-1 gap-4">
							{% for lineItem in cart.lineItems %}
								<li>
									{% include 'foster-checkout/_components/app/line-item-checkout' with { lineItem: lineItem } %}
								</li>
							{% endfor %}
						</ul>
					</div>

					{% include 'foster-checkout/_components/app/summary-cart' %}
				</div>

				{% include 'foster-checkout/_components/app/global-checkout-note' %}
			</aside>
		</div>
	</div>
{% endblock %}
