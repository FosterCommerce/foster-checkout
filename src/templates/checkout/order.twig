{% extends 'foster-checkout/_layouts/default' %}
{% set number = craft.app.request.getParam('number') %}
{% set order = craft.orders.number(number).isCompleted(true).withAdjustments().withTransactions().withLineItems().one() ?? null %}
{% if not order %}
	{% exit 404 %}
{% endif %}

{% block head %}
	<title>
		{{ craft.fostercheckout.settings.branding.title ? craft.fostercheckout.settings.branding.title : siteName }} |
		{{ 'misc.checkoutTitle'|t('foster-checkout') }} : {{ 'order.stepTitle'|t('foster-checkout') }}
	</title>
{% endblock %}

{% block body %}

	<div
		class="grid grid-cols-1 gap-4 mt-10 pb-10 lg:grid-cols-[1fr_380px] lg:gap-6 lg:mt-20 lg:pb-20 xl:grid-cols-[1fr_32.03125%] xl:gap-8">

		<main class="grid grid-cols-1 gap-8">
			<header>
				<h1 class="font-semibold text-3xl">
					{{ 'order.stepName'|t('foster-checkout') }}
				</h1>
			</header>

			<div class="lg:bg-white lg:rounded-lg {{ craft.fostercheckout.settings.branding.style|default('rounded') == 'flat' ? 'lg:border lg:border-gray-300' }}">
				{% set shippingAddress = order.shippingAddress ?? null %}
				{% if shippingAddress %}
					{% set q = (shippingAddress.addressLine1 ~ ' ' ~ shippingAddress.locality ~ ' ' ~ shippingAddress.administrativeArea)|url_encode %}
					<div class="relative w-full overflow-hidden rounded-lg aspect-[790/275]">
						<iframe
							class="absolute inset-0 h-full w-full"
							title="Shipping address map"
							loading="lazy"
							referrerpolicy="no-referrer-when-downgrade"
							src="https://maps.google.com/maps?hl=en&q={{ q }}+(Shipping%20address)&t=&z=18&ie=UTF8&iwloc=B&output=embed">
						</iframe>
					</div>
				{% endif %}

				<div class="p-4 space-y-2">
					<p>
						{{ 'order.orderNumberLabel'|t('foster-checkout') }}
						<strong>{{ order.reference }}</strong>
					</p>
					{# Only show email confirmation message if order confirmation email is configured and enabled #}
					{% set orderStatus = order.orderStatus %}
					{% if orderStatus.default == true %}
						{% set emails = orderStatus.getEmails() %}
						{% for email in emails|filter(email => email.enabled == true and email.recipientType == "customer" and email.getScenario() == "default") %}
							<p>{{ 'order.receiptEmailMessage'|t('foster-checkout') }}</p>
						{% endfor %}
					{% endif %}
				</div>
			</div>

			<div class="p-4 lg:bg-white lg:rounded-lg {{ craft.fostercheckout.settings.branding.style|default('rounded') == 'flat' ? 'lg:border lg:border-gray-300' }}">

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div class="grid grid-cols-1 content-start">

						<!-- Contact Information -->
						<div class="">
							<h2 class="text-lg font-medium text-gray-700">{{ 'order.contactInformation'|t('foster-checkout') }}</h2>
							<p class="">{{ order.email }}</p>
						</div>

						<!-- Shipping Address -->
						<div class="mt-4">
							<h2 class="text-lg font-medium text-gray-700">{{ 'order.shippingAddress'|t('foster-checkout') }}</h2>
							<address class="not-italic mt-1">
								{% include'foster-checkout/_components/app/formatted-address' with { 'address': order.shippingAddress} %}
							</address>
						</div>

						{% if order.shippingMethod %}
							<!-- Shipping Method -->
							<div class="mt-4">
								<h2 class="text-lg font-medium text-gray-700">{{ 'order.shippingMethod'|t('foster-checkout') }}</h2>
								<p class="mt-1">
									{{ order.shippingMethod.name }}
								</p>
							</div>
						{% endif %}
					</div>

					<div class="grid grid-cols-1 content-start">
						<!-- Payment Information -->
						<div>
							<h2 class="text-lg font-medium text-gray-700">{{ 'order.payment'|t('foster-checkout') }}</h2>
							{% if craft.app.plugins.isPluginEnabled('gift-voucher') %}
								{# Check for applied / redeemed gift card vouchers in orders #}

								{% if order.orderAdjustments|length >= 1 %}
									{#
									We currently only have access to the redeemed gift card vouchers code using order.orderAdjustments[0].description
									which appears in the form "Gift Voucher discount using code MTLYZKVDAQ"
									In order to get the code, we'll have to split the description string using 'code ' as its delimeter
									#}

									{% set voucherAdjustments = order.orderAdjustments|filter(adjustment => adjustment.type == 'voucher') %}
									{% if voucherAdjustments|length >= 1 %}
										<p class="mt-1">{{ 'order.giftCard'|t('foster-checkout') }}</p>
										{% for voucher in voucherAdjustments %}
											{# Get redeemed voucher code from description #}
											{% set voucherCode = voucher.description|split('code ')[1] is defined ? voucher.description|split('code ')[1] : false %}
											{# Get voucher remaining amount #}
											{% if voucherCode %}
												{% set amountRemaining = craft.giftVoucher.codes().codeKey(voucherCode).one().currentAmount %}
												{% set appliedVoucherAmount = (order.storedItemTotal - (voucher.amount|abs)) < 0 ? order.storedItemTotal : voucher.amount|abs %}
												{% set appliedVoucherDescription = voucher.description|split('code ')[1] ~ ' (' ~ appliedVoucherAmount|currency ~ ' applied, ' ~ amountRemaining|currency ~ ' remaining)' %}
												<p class="mt-1">{{ appliedVoucherDescription }}</p>
											{% endif %}
										{% endfor %}
									{% endif %}
								{% endif %}
							{% endif %}
							{% set transaction = order.transactions|last %}
							{% if transaction %}
								{% set paymentResponse = (transaction.response ?? null)|json_decode %}
								{% set cardBrand = null %}
								{% set cardLast4 = null %}

								{% if paymentResponse and paymentResponse.payment_method is defined and paymentResponse.payment_method.card is defined %}
									{% set cardBrand = paymentResponse.payment_method.card.display_brand ?? paymentResponse.payment_method.card.brand ?? null %}
									{% set cardLast4 = paymentResponse.payment_method.card.last4 ?? null %}
								{% elseif paymentResponse and paymentResponse.transactionResponse is defined %}
									{% set cardBrand = paymentResponse.transactionResponse.accountType ?? null %}
									{% set cardLast4 = paymentResponse.transactionResponse.accountNumber is defined ? paymentResponse.transactionResponse.accountNumber|slice(-4) : null %}
								{% endif %}

								{% if cardBrand or cardLast4 %}
									<p class="mt-1">
										{{ cardBrand ? cardBrand|capitalize ~ ' ' : '' }}{{ cardLast4 ? '**** ' ~ cardLast4 : '' }}
									</p>
								{% endif %}

								<p class="mt-1">
									{{ transaction.paymentAmount|float|currency(order.paymentCurrency) }}
									({{ 'order.dateChargedLabel'|t('foster-checkout') }} {{ order.dateOrdered|date }})
								</p>
							{% endif %}
						</div>

						<!-- Billing Address -->
						<div class="mt-4">
							<h2 class="text-lg font-medium text-gray-700">{{ 'order.billingAddress'|t('foster-checkout') }}</h2>
							<address class="not-italic mt-1">
								{% include'foster-checkout/_components/app/formatted-address' with { 'address': order.billingAddress} %}
							</address>
						</div>
					</div>
				</div>

				{% if order[craft.fostercheckout.settings.notes.order.fieldHandle] %}
					<h2 class="mt-6 mb-2 text-lg font-medium text-gray-700">Notes</h2>
					<div>
						{{ order[craft.fostercheckout.settings.notes.order.fieldHandle]|nl2br }}
					</div>
				{% endif %}

			</div>

			{% if craft.fostercheckout.settings.options.enableMadeAMistake %}
				{% set mistakeHeading = craft.fostercheckout.note('mistakeHeading') %}
				{% set mistakeText = craft.fostercheckout.note('mistakeText') %}
				<div class="hidden lg:block">
					{% if mistakeHeading %}
						<h3 class="font-semibold text-2xl">{{ mistakeHeading }}</h3>
					{% endif %}
					{% if mistakeText %}
						<div class="mt-6 space-y-2 text-gray-500">
							{{ mistakeText | raw }}
						</div>
					{% endif %}
				</div>
			{% endif %}

			{% include 'foster-checkout/_components/app/checkout-footer-links' %}

		</main>

		<aside>
			<div
				class="grid grid-cols-1 gap-10 lg:p-4 lg:bg-white lg:rounded-lg {{ craft.fostercheckout.settings.branding.style|default('rounded') == 'flat' ? 'lg:border lg:border-gray-300' }}">

				<div class="grid grid-cols-1 gap-4 xl:gap-6">

					<h2 class="text-xl font-bold text-gray-800 leading-snug">
						{{ 'summary.itemsTitle'|t('foster-checkout') }}
					</h2>

					<ul class="grid grid-cols-1 gap-4">
						{% for lineItem in order.lineItems %}
							<li>
								{% include 'foster-checkout/_components/app/line-item-checkout' with {
									lineItem: lineItem
								} %}
							</li>
						{% endfor %}
					</ul>

				</div>

				{% include 'foster-checkout/_components/app/summary-order' %}

			</div>
		</aside>

	</div>

	{% js %}
		try { localStorage.removeItem('fc_subscribe'); } catch (_) {}
	{% endjs %}

{% endblock %}
